rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isUser(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    function isBusiness(uid) {
      return exists(/databases/$(database)/documents/users/$(uid)) &&
             get(/databases/$(database)/documents/users/$(uid)).data.userType == 'business';
    }

    function businessExists(businessId) {
      return exists(/databases/$(database)/documents/businesses/$(businessId));
    }

    function isOwnerOfBusiness(businessId) {
      return businessExists(businessId) &&
             get(/databases/$(database)/documents/businesses/$(businessId)).data.ownerId == request.auth.uid;
    }

    function loyaltyCardExists(cardId) {
      return exists(/databases/$(database)/documents/loyaltyCards/$(cardId));
    }

    function businessIdOfLoyaltyCard(cardId) {
      return loyaltyCardExists(cardId) ? 
             get(/databases/$(database)/documents/loyaltyCards/$(cardId)).data.get('businessId', null) : 
             null;
    }

    function isOwnerOfLoyaltyCard(cardId) {
      return loyaltyCardExists(cardId) && isOwnerOfBusiness(businessIdOfLoyaltyCard(cardId));
    }

    function customerCardExists(cardId) {
      return exists(/databases/$(database)/documents/customerCards/$(cardId));
    }

    function customerIdOfCard(cardId) {
      return get(/databases/$(database)/documents/customerCards/$(cardId)).data.customerId;
    }

    function businessIdOfCard(cardId) {
      return get(/databases/$(database)/documents/customerCards/$(cardId)).data.businessId;
    }

    // USERS: Users can read/write their own user doc. Business users may GET customer user docs by ID (no listing).
    match /users/{userId} {
      allow read, write: if isUser(userId);
      allow get: if isSignedIn() && isBusiness(request.auth.uid) &&
                  exists(/databases/$(database)/documents/users/$(userId)) &&
                  get(/databases/$(database)/documents/users/$(userId)).data.userType == 'customer';
      // No 'list' for /users to prevent broad enumeration
    }

    // BUSINESSES: Owners can create/update/delete their businesses, all authed can read
    match /businesses/{businessId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if isSignedIn() && isOwnerOfBusiness(businessId) &&
                             // ownerId cannot change
                             request.resource.data.ownerId == resource.data.ownerId;
      
      // PUBLIC CODE DIRECTORY: For uniqueness checks
      match /takenCodes/{code} {
        allow read: if isSignedIn();
        allow create: if isSignedIn(); // Anyone can claim a code if they are creating a card
        allow delete: if isSignedIn(); // Cleanup allowed
      }
    }

    // LOYALTY CARDS: Created/managed by business owners
    match /loyaltyCards/{cardId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() &&
                    request.resource.data.keys().hasAll(['businessId']) &&
                    isOwnerOfBusiness(request.resource.data.businessId);
      allow update, delete: if isSignedIn() && isOwnerOfLoyaltyCard(cardId) &&
                             // businessId cannot change
                             request.resource.data.businessId == resource.data.businessId;
    }

    // CUSTOMER CARDS: Created by the customer; readable by the customer and the business owner; updates by customer or business owner
    match /customerCards/{cardId} {
      // Support list/queries: evaluate access based on each document's fields
      allow read: if isSignedIn() && (
                    isUser(resource.data.customerId) ||
                    isOwnerOfBusiness(resource.data.businessId)
                  );
      allow create: if isSignedIn() &&
                    request.resource.data.keys().hasAll(['customerId','loyaltyCardId','businessId']) &&
                    request.resource.data.customerId == request.auth.uid;
      allow update: if isSignedIn() && (
                      (resource != null && isUser(resource.data.customerId)) ||
                      (resource != null && isOwnerOfBusiness(resource.data.businessId))
                    );
      allow delete: if isSignedIn() && resource != null && isUser(resource.data.customerId);
    }    // STAMPS: Created by either the customer or the business owner of the related business. 
    // Can be deleted by customer who owns the card or business owner when deleting customer card.
    match /stamps/{stampId} {
      allow read: if isSignedIn() && resource != null && (
                    isUser(resource.data.customerId) || isOwnerOfBusiness(resource.data.businessId)
                  );
      allow create: if isSignedIn() &&
                    request.resource.data.keys().hasAll(['customerCardId','customerId','businessId','loyaltyCardId','timestamp']) &&
                    customerCardExists(request.resource.data.customerCardId) &&
                    // Cross-validate relationships
                    request.resource.data.customerId == customerIdOfCard(request.resource.data.customerCardId) &&
                    request.resource.data.businessId == businessIdOfCard(request.resource.data.customerCardId) &&
                    request.resource.data.loyaltyCardId == get(/databases/$(database)/documents/customerCards/$(request.resource.data.customerCardId)).data.loyaltyCardId &&
                    // Actor must be card customer or business owner
                    (isUser(request.resource.data.customerId) || isOwnerOfBusiness(request.resource.data.businessId));
      allow update: if false;
      allow delete: if isSignedIn() && resource != null && (
                      isUser(resource.data.customerId) || isOwnerOfBusiness(resource.data.businessId)
                    );
    }

    // REWARDS: Created by customer or business owner for a valid card. 
    // Can be deleted by customer who owns the card or business owner when deleting customer card.
    match /rewards/{rewardId} {
      allow read: if isSignedIn() && resource != null && (
                    isUser(resource.data.customerId) || isOwnerOfBusiness(resource.data.businessId)
                  );
      allow create: if isSignedIn() &&
                    request.resource.data.keys().hasAll(['customerCardId','customerId','businessId','loyaltyCardId','claimedAt','isRedeemed']) &&
                    customerCardExists(request.resource.data.customerCardId) &&
                    request.resource.data.customerId == customerIdOfCard(request.resource.data.customerCardId) &&
                    request.resource.data.businessId == businessIdOfCard(request.resource.data.customerCardId) &&
                    request.resource.data.loyaltyCardId == get(/databases/$(database)/documents/customerCards/$(request.resource.data.customerCardId)).data.loyaltyCardId &&
                    (isUser(request.resource.data.customerId) || isOwnerOfBusiness(request.resource.data.businessId));
      allow update: if false;
      allow delete: if isSignedIn() && resource != null && (
                      isUser(resource.data.customerId) || isOwnerOfBusiness(resource.data.businessId)
                    );
    }

    // STAMP ACTIVITY: Created alongside stamp events; readable by related parties. 
    // Can be deleted by customer who owns the card or business owner when deleting customer card.
    match /stampActivity/{activityId} {
      allow read: if isSignedIn() && resource != null && (
                    isUser(resource.data.customerId) || isOwnerOfBusiness(resource.data.businessId)
                  );
      allow create: if isSignedIn() &&
                    request.resource.data.keys().hasAll(['customerCardId','customerId','businessId','loyaltyCardId','timestamp','stampCount']) &&
                    customerCardExists(request.resource.data.customerCardId) &&
                    request.resource.data.customerId == customerIdOfCard(request.resource.data.customerCardId) &&
                    request.resource.data.businessId == businessIdOfCard(request.resource.data.customerCardId) &&
                    request.resource.data.loyaltyCardId == get(/databases/$(database)/documents/customerCards/$(request.resource.data.customerCardId)).data.loyaltyCardId &&
                    (isUser(request.resource.data.customerId) || isOwnerOfBusiness(request.resource.data.businessId));
      allow update: if false;
      allow delete: if isSignedIn() && resource != null && (
                      isUser(resource.data.customerId) || isOwnerOfBusiness(resource.data.businessId)
                    );
    }

    // STAMP ACTIVITY: Created alongside stamp events; readable by related parties. 
    // Can be deleted by customer who owns the card or business owner when deleting customer card.
    match /stampActivity/{activityId} {
      allow read: if isSignedIn() && resource != null && (
                    isUser(resource.data.customerId) || isOwnerOfBusiness(resource.data.businessId)
                  );
      allow create: if isSignedIn() &&
                    request.resource.data.keys().hasAll(['customerCardId','customerId','businessId','loyaltyCardId','timestamp','stampCount']) &&
                    customerCardExists(request.resource.data.customerCardId) &&
                    request.resource.data.customerId == customerIdOfCard(request.resource.data.customerCardId) &&
                    request.resource.data.businessId == businessIdOfCard(request.resource.data.customerCardId) &&
                    request.resource.data.loyaltyCardId == get(/databases/$(database)/documents/customerCards/$(request.resource.data.customerCardId)).data.loyaltyCardId &&
                    (isUser(request.resource.data.customerId) || isOwnerOfBusiness(request.resource.data.businessId));
      allow update: if false;
      allow delete: if isSignedIn() && resource != null && (
                      isUser(resource.data.customerId) || isOwnerOfBusiness(resource.data.businessId)
                    );
    }
  }
}